= Developer Guide
:doctype: book
:icons: font
:source-highlighter: highlight.js
:toc: left
:toclevels: 3

include::_attributes.adoc[]

This guide covers how to create custom widgets and components for {project-name}.

== Creating Custom Widgets

{project-name} provides two widget interfaces depending on whether your widget needs external state.

=== Stateless Widgets

For widgets that render the same output given the same inputs:

[source,java]
----
include::{snippets-dir}/dev/tamboui/docs/snippets/DeveloperGuideSnippets.java[tags=widget-interface]
----

Example: A custom separator widget:

[source,java]
----
include::{snippets-dir}/dev/tamboui/docs/snippets/DeveloperGuideSnippets.java[tags=separator-widget]
----

=== Stateful Widgets

For widgets that need to track selection, scroll position, or other state:

[source,java]
----
include::{snippets-dir}/dev/tamboui/docs/snippets/DeveloperGuideSnippets.java[tags=stateful-widget-interface]
----

Example: A custom counter widget:

[source,java]
----
include::{snippets-dir}/dev/tamboui/docs/snippets/DeveloperGuideSnippets.java[tags=counter-widget]
----

Usage:

[source,java]
----
include::{snippets-dir}/dev/tamboui/docs/snippets/DeveloperGuideSnippets.java[tags=counter-usage]
----

== Buffer Operations

=== Setting Cells

[source,java]
----
include::{snippets-dir}/dev/tamboui/docs/snippets/DeveloperGuideSnippets.java[tags=setting-cells]
----

=== Reading Cells

[source,java]
----
include::{snippets-dir}/dev/tamboui/docs/snippets/DeveloperGuideSnippets.java[tags=reading-cells]
----

=== Filling Areas

[source,java]
----
include::{snippets-dir}/dev/tamboui/docs/snippets/DeveloperGuideSnippets.java[tags=filling-areas]
----

=== Bounds Checking

Always check bounds before writing:

[source,java]
----
include::{snippets-dir}/dev/tamboui/docs/snippets/DeveloperGuideSnippets.java[tags=bounds-checking]
----

== Exporting Buffer Content

You can export a `Buffer` to SVG, HTML, or plain/ANSI text for screenshots, documentation, or sharing. The API is fluent: start from `export(buffer)` (static import {@code ExportRequest.export}), choose a format, optionally configure options, then write to a file, stream, or string.

=== Fluent API

[source,java]
----
include::{snippets-dir}/dev/tamboui/docs/snippets/DeveloperGuideSnippets.java[tags=export-fluent-api]
----

=== Format Selection

Use the shorthand methods for the built-in formats:

* `export(buffer).svg()` -- SVG (scalable vector graphic)
* `export(buffer).html()` -- HTML document (with embedded or external CSS)
* `export(buffer).text()` -- Plain text or ANSI-styled text

To use a custom format, pass it to `as(Format)`:

[source,java]
----
include::{snippets-dir}/dev/tamboui/docs/snippets/DeveloperGuideSnippets.java[tags=export-custom-format]
----

You can also export by file path and let the extension choose the format:

[source,java]
----
include::{snippets-dir}/dev/tamboui/docs/snippets/DeveloperGuideSnippets.java[tags=export-by-extension]
----

Extension mapping: `.svg` -> SVG; `.html` / `.htm` -> HTML; `.txt` / `.asc` -> plain text; `.ans` / `.ansi` -> ANSI text. Unknown extensions default to SVG.

=== Output Methods

After choosing a format (and optionally configuring options), use:

* `toFile(Path path)` -- write to a file (UTF-8)
* `to(OutputStream out)` -- write to a stream (UTF-8)
* `to(Writer out)` -- write to a writer (caller controls charset; writer is not closed)
* `toString()` -- return the exported string
* `toBytes()` -- return UTF-8 bytes

=== Cropping to a region

Use `crop(Rect)` to export only part of the buffer. The rect is clipped to buffer bounds. Returns a new request (immutable); chain with format and output as usual.

[source,java]
----
include::{snippets-dir}/dev/tamboui/docs/snippets/DeveloperGuideSnippets.java[tags=export-cropping]
----

In Toolkit apps, use `Element.renderedArea()` after a frame is rendered to get an element's last rendered rect, then crop to that rect to export just that element:

[source,java]
----
include::{snippets-dir}/dev/tamboui/docs/snippets/DeveloperGuideSnippets.java[tags=export-element-area]
----

=== Default export colors

Export formats use a default foreground and background when a cell style does not specify colors (e.g. after RESET). When you do not pass a resolver, export uses those property defaults.

To supply custom defaults (e.g. from the toolkit style engine), pass a `StylePropertyResolver` via `styles(...)`. The resolver can provide values for the properties `export-foreground` and `export-background`:

[source,java]
----
include::{snippets-dir}/dev/tamboui/docs/snippets/DeveloperGuideSnippets.java[tags=export-default-colors]
----

=== SVG Export

SVG export produces a standalone SVG document suitable for embedding or conversion to PNG/PDF.

Options (`SvgOptions`), via `.options(o -> ...)`:

* `title(String)` -- window/title text (default: `"TamboUI"`)
* `chrome(boolean)` -- include window frame, title, and traffic-light buttons (default: `true`); `false` for content only
* `styles(StylePropertyResolver)` -- style resolver for default export foreground/background (properties `export-foreground`, `export-background`); when `null` (default), uses `ExportProperties` defaults (dark theme)
* `fontAspectRatio(double)` -- character width-to-height ratio for layout (default: 0.61)
* `uniqueId(String)` -- prefix for CSS classes and clip paths, or `null` for auto-generated

[source,java]
----
include::{snippets-dir}/dev/tamboui/docs/snippets/DeveloperGuideSnippets.java[tags=export-svg-options]
----

=== HTML Export

HTML export produces a full HTML document with styled `<pre>` content. Styles can be embedded in each `<span>` or placed in a `<style>` block.

Options (`HtmlOptions`):

* `styles(StylePropertyResolver)` -- style resolver for default export foreground/background (same as SVG); when `null` (default), uses `ExportProperties` defaults
* `inlineStyles(boolean)` -- `true` for inline styles on each span (single-file, larger); `false` for a stylesheet (default, smaller HTML)

[source,java]
----
include::{snippets-dir}/dev/tamboui/docs/snippets/DeveloperGuideSnippets.java[tags=export-html-options]
----

=== Text Export

Text export produces plain text or ANSI-escape-styled text (e.g. for pasting into terminals or logs).

Options (`TextOptions`):

* `styles(boolean)` -- `true` to include ANSI escape codes for colors and modifiers; `false` for plain text only (default)

[source,java]
----
include::{snippets-dir}/dev/tamboui/docs/snippets/DeveloperGuideSnippets.java[tags=export-text-options]
----

== Creating Toolkit Components

For Toolkit DSL integration, extend the `Component` class.
Components use the link:bindings.html[@OnAction annotation] to handle input through the bindings system:

[source,java]
----
include::{snippets-dir}/dev/tamboui/docs/snippets/DeveloperGuideSnippets.java[tags=counter-card]
----

=== Using Components

Components require an ID:

[source,java]
----
include::{snippets-dir}/dev/tamboui/docs/snippets/DeveloperGuideSnippets.java[tags=using-components]
----

== CSS Property Support

Widgets can support CSS styling by accepting a `StylePropertyResolver` and using `PropertyDefinition` to define custom properties.

=== Defining Custom Properties

Define custom properties as static constants using `PropertyDefinition` and register them with `PropertyRegistry`:

[source,java]
----
include::{snippets-dir}/dev/tamboui/docs/snippets/DeveloperGuideSnippets.java[tags=custom-properties]
----

TIP: For multiple properties, use `PropertyRegistry.registerAll(PROP1, PROP2, ...)`.

Registering properties with `PropertyRegistry` is important because:

* Style resolvers use the registry to validate property names
* Unregistered properties may trigger warnings or errors depending on configuration
* Registration enables the property converter to be used during style resolution

This allows users to style your widget with CSS:

[source,css]
----
MyGauge {
    bar-color: green;
}
----

=== Using StylePropertyResolver

Widgets accept a `StylePropertyResolver` through their builder to resolve CSS values:

[source,java]
----
include::{snippets-dir}/dev/tamboui/docs/snippets/DeveloperGuideSnippets.java[tags=style-property-resolver]
----

The resolution order is:

1. **Programmatic value** - value set via builder method (e.g., `.barColor(Color.GREEN)`)
2. **CSS value** - value from the style resolver
3. **Property default** - value from `PropertyDefinition.defaultValue()`

=== Using Standard Properties

For common properties like `color` and `background`, use `StandardProperties`:

[source,java]
----
include::{snippets-dir}/dev/tamboui/docs/snippets/DeveloperGuideSnippets.java[tags=standard-properties]
----

=== Inheritable vs Non-Inheritable

Inheritance controls whether a property value flows from parent elements to children in the element tree.

**Inheritable properties** (like `color`) propagate down automatically:

[source,css]
----
Panel {
    color: cyan;  /* All Text elements inside Panel inherit this */
}
----

**Non-inheritable properties** (like `background`) apply only to the target element:

[source,css]
----
Panel {
    background: gray;  /* Only Panel gets this, not its children */
}
----

When defining your own properties:

* Use `PropertyDefinition.of(...)` for properties that should NOT inherit (most widget-specific properties like `bar-color`, `cursor-color`)
* Use `PropertyDefinition.builder(...).inheritable().build()` for properties that SHOULD inherit (rare - typically only text-related properties)

Most widget-specific properties should be non-inheritable because they control aspects unique to that widget type.

== Unicode and Display Width Handling

Terminal display width differs from Java string length.
Always use `CharWidth` utilities for width calculations when rendering text.

=== The Problem

Java's `String.length()` returns the number of UTF-16 code units, not terminal display columns:

|===
| Type | Example | `length()` | Display Width

| ASCII | "A" | 1 | 1
| CJK | "世" | 1 | 2
| Simple Emoji | "火" | 2 | 2
| ZWJ Emoji | "man-bald" | 5 | 2
| Flag Emoji | "flag-GL" | 4 | 2
|===

Using `length()` or `substring()` for display calculations causes:

* ZWJ emoji like "man-bald" to display as "man?" (truncated mid-sequence)
* CJK characters to overflow cells (width 2 treated as width 1)
* Incorrect cursor positioning and alignment

=== CharWidth Utilities

The `CharWidth` class provides display-width-aware string operations:

[source,java]
----
include::{snippets-dir}/dev/tamboui/docs/snippets/DeveloperGuideSnippets.java[tags=charwidth-basics]
----

=== Common Patterns

==== Width Calculation

[source,java]
----
include::{snippets-dir}/dev/tamboui/docs/snippets/DeveloperGuideSnippets.java[tags=charwidth-calculation]
----

==== Text Truncation

[source,java]
----
include::{snippets-dir}/dev/tamboui/docs/snippets/DeveloperGuideSnippets.java[tags=charwidth-truncation]
----

==== Position Tracking

[source,java]
----
include::{snippets-dir}/dev/tamboui/docs/snippets/DeveloperGuideSnippets.java[tags=charwidth-position-tracking]
----

==== Centering Text

[source,java]
----
include::{snippets-dir}/dev/tamboui/docs/snippets/DeveloperGuideSnippets.java[tags=charwidth-centering]
----

==== Truncation with Ellipsis

[source,java]
----
include::{snippets-dir}/dev/tamboui/docs/snippets/DeveloperGuideSnippets.java[tags=charwidth-ellipsis]
----

=== Ellipsis Truncation Positions

`CharWidth.truncateWithEllipsis()` supports three positions:

[source,java]
----
include::{snippets-dir}/dev/tamboui/docs/snippets/DeveloperGuideSnippets.java[tags=charwidth-truncate-positions]
----

You can also use a custom ellipsis string:

[source,java]
----
include::{snippets-dir}/dev/tamboui/docs/snippets/DeveloperGuideSnippets.java[tags=charwidth-custom-ellipsis]
----

=== ZWJ Sequence Safety

Zero-Width Joiner (ZWJ) sequences combine multiple code points into a single visible glyph.
`CharWidth.substringByWidth()` automatically preserves these sequences:

[source,java]
----
include::{snippets-dir}/dev/tamboui/docs/snippets/DeveloperGuideSnippets.java[tags=charwidth-zwj-safety]
----

=== Reference Implementation

See `Paragraph.java` for a complete example of correct CharWidth usage in a widget that handles text wrapping and truncation.

== Best Practices

=== Widget Design

* Keep widgets focused on a single responsibility
* Use the builder pattern for complex configuration
* Respect the provided `Rect` bounds
* Handle edge cases (empty area, no data)
* Always use `CharWidth` for text width calculations (see <<Unicode and Display Width Handling>>)

=== Performance

* Minimize allocations in `render()` methods
* Pre-compute strings and styles when possible
* Use primitive arrays over collections for large data

=== State Management

* Keep state classes simple
* Provide methods for all state modifications
* Consider immutable state for thread safety

== Next Steps

* Review the link:widgets.html[Widgets Reference] to see existing implementations
* Learn about link:bindings.html[Bindings and Actions] for handling input
* Study link:mvc-architecture.html[Application Structure] for organizing larger apps

== Further Reading

For more details, explore the source code:

* `tamboui-widgets/src/main/java/dev/tamboui/widgets/` - Widget implementations
* `tamboui-toolkit/src/main/java/dev/tamboui/toolkit/` - Toolkit components
* `tamboui-core/src/main/java/dev/tamboui/buffer/` - Buffer and Cell
* `tamboui-core/src/main/java/dev/tamboui/export/` - Export API (SVG, HTML, text)
* `tamboui-core/src/main/java/dev/tamboui/text/CharWidth.java` - Unicode display width utilities
* `tamboui-widgets/src/main/java/dev/tamboui/widgets/paragraph/Paragraph.java` - Reference implementation for CharWidth usage
